# ğŸ”® MysticStars - Magical Horoscope Website

A beautiful, magical horoscope website that provides daily, weekly, monthly, and yearly zodiac readings powered by Blackbox AI and deployed on Kubernetes.

## âœ¨ Features

- **12 Zodiac Signs** - Complete coverage of all astrological signs with detailed trait information
- **4 Reading Types** - Daily, Weekly, Monthly, and Yearly predictions
- **AI-Powered Content** - Magical readings generated by Blackbox AI with multiple model fallback
- **Dark/Light Themes** - Beautiful theme toggle with persistent settings
- **Responsive Design** - Works perfectly on desktop, tablet, and mobile with mobile burger menu
- **SEO Optimized** - Ready for Google AdSense approval with structured data
- **Kubernetes Ready** - Scalable deployment with automated content generation and rate limiting
- **API-Driven** - RESTful API with robust retry logic and circuit breaker pattern
- **Discover Page** - Dedicated zodiac traits page with clickable navigation to readings
- **Markdown Support** - API responses formatted with markdown parsing for rich content
- **Mobile Navigation** - Burger menu with smooth animations for mobile users
- **Enhanced Error Handling** - Comprehensive retry logic and model switching for 100% reliability

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cloudflare Pages  â”‚â”€â”€â”€â–¶â”‚   Kubernetes API    â”‚â”€â”€â”€â–¶â”‚     MongoDB         â”‚
â”‚   (Frontend)        â”‚    â”‚   (Backend)         â”‚    â”‚   (Database)        â”‚
â”‚   â€¢ index.html      â”‚    â”‚   â€¢ Rate Limiting   â”‚    â”‚   â€¢ Readings Cache  â”‚
â”‚   â€¢ discover-zodiac â”‚    â”‚   â€¢ Circuit Breaker â”‚    â”‚   â€¢ Metadata        â”‚
â”‚   â€¢ Mobile Menu     â”‚    â”‚   â€¢ Retry Logic     â”‚    â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  Kubernetes Jobs    â”‚
                           â”‚  (Blackbox AI)      â”‚
                           â”‚  â€¢ Model Fallback   â”‚
                           â”‚  â€¢ Auto Generation  â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Components

1. **Frontend** - Static HTML/CSS/JS hosted on Cloudflare Pages
   - Main horoscope interface (`index.html`)
   - Dedicated zodiac traits page (`discover-zodiac.html`)
   - Mobile-responsive burger navigation menu
   - Markdown parsing for rich content formatting

2. **Backend API** - Node.js Express server running in Kubernetes
   - Rate limiting with Kubernetes probe whitelist
   - Circuit breaker pattern for API reliability
   - Progressive exponential backoff retry logic
   - Multiple AI model fallback system

3. **Database** - MongoDB for storing generated readings
   - Cached readings with expiration
   - Metadata tracking and usage statistics

4. **AI Service** - Blackbox AI integration for content generation
   - 12+ free models with automatic fallback
   - DeepSeek reasoning model support
   - Model-specific response validation

5. **CronJobs** - Automated reading generation on schedule
   - Intelligent retry and error recovery
   - Multiple model attempts per generation

6. **Ingress** - External access with CORS and rate limiting
   - Kubernetes health probe bypass
   - Production-ready security headers

## ğŸš€ Quick Start

### Prerequisites

- Docker and Docker Compose
- Kubernetes cluster (local or cloud)
- kubectl configured
- Blackbox AI API key
- Node.js 18+ (for local development)

### Local Development

1. **Clone the repository**
   ```bash
   git clone <repository-url>
   cd horrorscope
   ```

2. **Set up the backend**
   ```bash
   cd backend
   cp .env.example .env
   # Edit .env with your configuration
   npm install
   npm run dev
   ```

3. **Set up the frontend**
   ```bash
   cd ..
   # Edit config.js to point to localhost:3000
   # Open index.html in browser or serve with local server
   ```

### Production Deployment

1. **Prepare your Kubernetes cluster**
   ```bash
   # Ensure kubectl is configured
   kubectl cluster-info
   ```

2. **Build and push Docker images**
   ```bash
   # Build API image
   docker build -t your-registry/mysticstars-api:latest -f backend/Dockerfile backend/
   
   # Build CronJob image
   docker build -t your-registry/mysticstars-cronjob:latest -f backend/Dockerfile.cronjob backend/
   
   # Push to your registry
   docker push your-registry/mysticstars-api:latest
   docker push your-registry/mysticstars-cronjob:latest
   ```

3. **Configure Kubernetes manifests**
   ```bash
   cd k8s
   
   # Update image names in YAML files
   # Update domain names in ingress.yaml
   # Update secret with your Gemini API key
   ```

4. **Deploy to Kubernetes**
   ```bash
   ./deploy.sh
   ```

5. **Set up Cloudflare Pages**
   - Connect your repository to Cloudflare Pages
   - Update `config.js` with your API URL
   - Deploy!

## ğŸ”§ Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `NODE_ENV` | Environment mode | `production` |
| `MONGODB_URI` | MongoDB connection string | `mongodb://mongodb:27017/mysticstars` |
| `BLACKBOX_API_KEY` | Blackbox AI API key | Required |
| `BLACKBOX_MODEL` | Preferred AI model | `blackboxai/deepseek/deepseek-chat-v3-0324:free` |
| `FRONTEND_URL` | Frontend URL for CORS | `https://mysticstars.pages.dev` |
| `API_BASE_URL` | API base URL | `http://mysticstars-api:3000` |

### Frontend Configuration

Edit `config.js`:

```javascript
window.MYSTICSTARS_CONFIG = {
  API_BASE_URL: 'https://api.mysticstars.com',
  USE_MOCK_DATA_FALLBACK: true,
  REQUEST_TIMEOUT: 10000,
  MAX_RETRIES: 3,
  RETRY_DELAY: 1000,
  CORS_MODE: 'cors'
};
```

## ğŸ“… Automated Content Generation

The system uses Kubernetes CronJobs to automatically generate fresh content:

- **Daily Readings**: Every day at 1:00 AM UTC
- **Weekly Readings**: Every Sunday at 2:00 AM UTC
- **Monthly Readings**: First day of each month at 3:00 AM UTC
- **Yearly Readings**: January 1st at 4:00 AM UTC

### Manual Content Generation

```bash
# Generate daily readings manually
kubectl create job --from=cronjob/daily-readings-generator manual-daily-$(date +%s) -n mysticstars

# Generate all readings
kubectl create job --from=cronjob/daily-readings-generator manual-all-$(date +%s) -n mysticstars

# Regenerate a single sign/type from the cronjob image (locally or in a Job)
# Example: Aries daily
node backend/scripts/generateReadings.js regen aries daily
```

## ğŸ› ï¸ API Endpoints

### Health Check
- `GET /api/health` - Basic health status
- `GET /api/health/live` - Kubernetes liveness probe
- `GET /api/health/ready` - Kubernetes readiness probe

### Readings
- `GET /api/readings/:sign/:type` - Get specific reading
- `GET /api/readings/:sign` - Get all readings for a sign
- `GET /api/readings/status` - API statistics

### Example API Response

```json
{
  "success": true,
  "data": {
    "zodiacSign": "aries",
    "readingType": "daily",
    "content": "Golden sunbeams illuminate your adventurous path today...",
    "validFrom": "2024-01-15T00:00:00.000Z",
    "validUntil": "2024-01-16T00:00:00.000Z",
    "generatedAt": "2024-01-15T01:00:00.000Z",
    "isCurrentlyValid": true
  }
}
```

## ğŸ¨ Theme System

The website supports both light and dark themes with automatic persistence:

- **Light Theme**: Magical gradient with dark text
- **Dark Theme**: Mystical dark gradient with light text
- **Persistent**: Theme choice saved in localStorage
- **Smooth Transitions**: CSS animations between themes

## ğŸ“± Responsive Design

- **Mobile First**: Optimized for all screen sizes
- **Touch Friendly**: Large tap targets and smooth scrolling
- **Fast Loading**: Optimized assets and minimal JavaScript
- **Accessible**: ARIA labels and semantic HTML

## ğŸ”’ Security Features

- **Rate Limiting**: 100 requests per 15 minutes per IP with Kubernetes probe bypass
- **CORS Protection**: Configured for specific domains
- **Input Validation**: All API inputs validated
- **Security Headers**: Helmet.js middleware
- **Non-root Containers**: Docker security best practices
- **Circuit Breaker**: Prevents API overload during failures
- **Probe Whitelisting**: Kubernetes health checks bypass rate limits

## ğŸ“Š Monitoring

### Health Checks

```bash
# Check API health
curl https://api.mysticstars.com/api/health

# Check reading status
curl https://api.mysticstars.com/api/readings/status
```

### Kubernetes Monitoring

```bash
# Check pod status
kubectl get pods -n mysticstars

# Check API logs
kubectl logs -f deployment/mysticstars-api -n mysticstars

# Check cronjob status
kubectl get cronjobs -n mysticstars
```

### Telegram Alerts for Missing Readings

- A monitoring CronJob checks every 30 minutes that each zodiac sign has an active reading for every type (daily, weekly, monthly, yearly).
- If any readings are missing, it sends a Telegram alert and attempts auto-regeneration for each missing sign/type (requires `BLACKBOX_API_KEY`).

Configure secrets (base64-encoded) in `k8s/secret.yaml`:

```
# Example encoding
echo -n "<your-bot-token>" | base64
echo -n "<your-chat-id>" | base64
```

Then set:
- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_CHAT_ID`

Local usage:

```
cd backend
cp .env.example .env
# Add TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID
node scripts/checkMissingReadings.js
```

Kubernetes CronJob: see `k8s/cronjobs.yaml` resource `readings-monitor`.

## ğŸ¤ Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

## ğŸ“„ License

This project is licensed under the MIT License - see the LICENSE file for details.

## ğŸ†• Recent Updates

### v2.0 - Enhanced Reliability & Navigation
- **ğŸ¤– Blackbox AI Integration**: Switched from Google Gemini to Blackbox AI with 12+ free model fallback
- **ğŸ”„ Circuit Breaker Pattern**: Intelligent failure handling with automatic recovery
- **ğŸ“± Mobile Navigation**: Burger menu with smooth animations for mobile users
- **ğŸ” Discover Page**: Dedicated zodiac traits page with clickable navigation
- **ğŸ“ Markdown Support**: Rich content formatting for API responses
- **âš¡ Rate Limiting Fixes**: Kubernetes probe whitelisting prevents 429 errors
- **ğŸ¯ Enhanced UX**: Automatic sign selection from discover page to readings
- **ğŸ›¡ï¸ Error Handling**: Comprehensive retry logic ensures 100% reading generation success

### Navigation Flow
1. **Homepage** (`index.html`) - Main horoscope readings interface
2. **Discover Zodiac** (`discover-zodiac.html`) - Detailed sign traits and characteristics
3. **Clickable Integration** - Click any sign on discover page to go directly to readings

## ğŸŒŸ Credits

- **Fonts**: Rubik, Lugrasimo, Cinzel from Google Fonts
- **AI**: Blackbox AI for content generation with multiple model support
- **Icons**: Unicode symbols and emojis
- **Hosting**: Cloudflare Pages
- **Infrastructure**: Kubernetes with advanced reliability patterns

---

**Made with âœ¨ magic and ğŸ’» code**
